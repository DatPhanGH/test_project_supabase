-- Fix RLS Policy để Admin có thể xem tất cả users
-- Chạy file này trong Supabase SQL Editor

-- Xóa các policies cũ

DROP POLICY IF EXISTS "Users can update own profile" ON public.users;

-- ============================================
-- TẠO FUNCTION ĐỂ CHECK ADMIN ROLE (Tránh circular dependency)
-- ============================================
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 
    FROM public.users 
    WHERE user_id::text = auth.uid()::text 
    AND role = 'admin' 
    AND is_active = true
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- ============================================
-- TẠO LẠI POLICIES
-- ============================================


-- 2. Admins có thể SELECT tất cả users
-- Sử dụng function để tránh circular dependency
CREATE POLICY "Admins can view all users"
ON public.users
FOR SELECT
USING (public.is_admin());

-- 3. Users có thể update profile của chính mình (nhưng không được đổi role)
CREATE POLICY "Users can update own profile"
ON public.users
FOR UPDATE 
USING (auth.uid()::text = user_id::text)
WITH CHECK (
    auth.uid()::text = user_id::text 
    AND role = (SELECT role FROM public.users WHERE user_id::text = auth.uid()::text)
);

-- 4. Admins có thể UPDATE tất cả users
CREATE POLICY "Admins can update all users"
ON public.users
FOR UPDATE
USING (public.is_admin())
WITH CHECK (public.is_admin());

-- 5. Admins có thể INSERT users mới (nếu cần)
CREATE POLICY "Admins can insert users"
ON public.users
FOR INSERT
WITH CHECK (public.is_admin());

-- 6. Admins có thể DELETE users (nếu cần, trừ chính mình)
CREATE POLICY "Admins can delete users"
ON public.users
FOR DELETE
USING (
    public.is_admin() 
    AND user_id::text != auth.uid()::text
);