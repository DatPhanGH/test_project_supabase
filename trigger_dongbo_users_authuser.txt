-- ü™Ñ T·ª± ƒë·ªông th√™m b·∫£n ghi v√†o public.users khi c√≥ user m·ªõi trong auth.users

-- 1Ô∏è‚É£ T·∫°o h√†m ƒë·ªìng b·ªô
CREATE OR REPLACE FUNCTION public.handle_new_auth_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (user_id, name, email, role)
  VALUES (
    NEW.id,                           -- id t·ª´ auth.users
    NEW.raw_user_meta_data->>'full_name',
    NEW.email,
    'user'
  )
  ON CONFLICT (user_id) DO NOTHING; -- tr√°nh tr√πng l·∫∑p n·∫øu ƒë√£ t·ªìn t·∫°i
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2Ô∏è‚É£ T·∫°o trigger
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_auth_user();
